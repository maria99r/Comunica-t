<p-toast position="top-right" key="productCart" life=2000 />
<p-toast position="top-right" key="delete-review" life=2000 />

@if (product) {
<div class="container">

    <!--imagen producto-->
    <section class="imageProduct m-auto">
        <img [src]="IMG_URL + product.image" class="m-auto w-full">
    </section>

    <!-- info del producto -->
    <section class="infoProduct">
        <h1>{{product.name}}</h1>
        <p class="numRef">Identificador de art√≠culo: {{product.id}}</p>
        <span class="price">{{product.price/100}}‚Ç¨</span>
        <p [innerHTML]="product.description"></p>

        <p class="stockQuantityText">{{product.stock}} en stock</p>
        <div class="inputQuantity">
            @if (product.stock > 0) {
            <p-inputNumber [(ngModel)]="quantity" [showButtons]="true" buttonLayout="horizontal" inputId="horizontal"
                spinnerMode="horizontal" [step]="1" [min]="1" [max]="product.stock" allowEmpty=false
                decrementButtonClass="p-button-secondary" incrementButtonClass="p-button-secondary"
                incrementButtonIcon="pi pi-plus" decrementButtonIcon="pi pi-minus" />
            } @else {
            <p-inputNumber [(ngModel)]="product.stock" [showButtons]="true" buttonLayout="horizontal"
                inputId="horizontal" spinnerMode="horizontal" decrementButtonClass="p-button-secondary"
                incrementButtonClass="p-button-secondary" incrementButtonIcon="pi pi-plus"
                decrementButtonIcon="pi pi-minus" readonly />
            }
        </div>

        <!-- boton a√±adir cesta -->
        <button (click)="addToCart()" class="mt-4 p-button font-bold vertical-align-middle"
            [disabled]="product.stock <= 0">A√±adir a la cesta</button>

    </section>

    <section class="w-full">
        <h1>Rese√±as</h1>
        <p>{{reviews.length}} rese√±as. Media:
            <span>
                @switch (this.avg) {
                @case (1) {
                ‚≠ê‚≠ê‚≠ê
                }
                @case (0) {
                ‚≠ê‚≠ê‚ú©
                }
                @case (-1) {
                ‚≠ê‚ú©‚ú©
                }
                }
            </span>
        </p>

        <p *ngIf="!authService.isAuthenticated()">
            Para poder escribir una rese√±a debe
            <a [routerLink]="'/login'" [queryParams]="{ redirectTo: router.url }">iniciar sesi√≥n.</a>
        </p>

        <!-- FORMULARIO PARA HACER RESE√ëA -->
        <div *ngIf="authService.isAuthenticated() && hasPurchased && !hasComment">
            <p>A√±ade una rese√±a:</p>
            <form (ngSubmit)="publicReview()">
                <textarea class="w-full" rows="7" pInputText [(ngModel)]="textReview"
                    [ngModelOptions]="{standalone: true}" placeholder="¬°Comenta aqu√≠ que te ha parecido el producto!">
                </textarea> <br><br>
                <input type="submit" value="Enviar" class="p-button" />
            </form>
        </div>

        <!--  si ya ha comentado -->
        <div *ngIf="authService.isAuthenticated() && hasComment">
            <p class="font-bold">Ya has dejado una rese√±a para este producto. ¬°Gracias por tu opini√≥n!</p>
        </div>

        <!-- Si el usuario no ha comprado el producto -->
        <div *ngIf="authService.isAuthenticated() && !hasPurchased">
            <p class="font-bold">Para poder dejar una rese√±a, debes haber comprado este producto.</p>
        </div>


        <br>

        @for (review of reviews; track review.reviewId) {
        <div class="review">
            <!-- nombre usuario que ha comentado-->
            @for (user of users; track user.userId) {
            @if(user.userId == review.userId){
            <span class="font-bold"> üë§ {{user.name}} </span>
            }
            }

            @switch (review.label) {
            @case (1) {
            <span>‚≠ê‚≠ê‚≠ê</span>
            }
            @case (0) {
            <span> ‚≠ê‚≠ê‚ú©</span>
            }
            @case (-1) {
            <span> ‚≠ê‚ú©‚ú© </span>
            }
            }
            <span style="float: inline-end; padding-right: 10px;"> {{review.date | date:'dd MMM YYYY HH:mm' |
                lowercase}}</span>


            <p class="m-2 text-sm">{{review.text}}
                <span class="delete" *ngIf="authService.isAuthenticated()">
                    <img *ngIf="authService.isAdmin() || review.userId == user.userId" src="icons/bin.svg"
                        class="delete-icon" alt="Borrar" (click)="deleteReview(review.reviewId)">
                </span>
            </p>

        </div>

        }
        @empty {
        <div>No hay rese√±as</div>
        }
    </section>
</div>
}